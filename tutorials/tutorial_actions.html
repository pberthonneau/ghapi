<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.75">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>../ghapi - Getting started with GitHub Actions</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: 1;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="../ghapi - Getting started with GitHub Actions">
<meta property="og:description" content="GitHub Actions help you automate tasks within your software development life cycle. GitHub say that:">
<meta property="og:site-name" content="../ghapi">
<meta name="twitter:title" content="../ghapi - Getting started with GitHub Actions">
<meta name="twitter:description" content="GitHub Actions help you automate tasks within your software development life cycle. GitHub say that:">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">ghapi</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/fastai/ghapi/tree/master/"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Getting started with GitHub Actions</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">ghapi</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../core.html" class="sidebar-item-text sidebar-link">GhApi details</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../actions.html" class="sidebar-item-text sidebar-link">GitHub Actions details</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../auth.html" class="sidebar-item-text sidebar-link">Authentication</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../page.html" class="sidebar-item-text sidebar-link">Pagination</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../event.html" class="sidebar-item-text sidebar-link">The events API</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cli.html" class="sidebar-item-text sidebar-link">Command line interface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../50_fullapi.html" class="sidebar-item-text sidebar-link">Full GitHub API reference</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../build_lib.html" class="sidebar-item-text sidebar-link">Internal - OpenAPI Parser</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">tutorials</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/tutorial_actions.html" class="sidebar-item-text sidebar-link active">Getting started with GitHub Actions</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#about-github-actions" id="toc-about-github-actions" class="nav-link active" data-scroll-target="#about-github-actions">About GitHub Actions</a></li>
  <li><a href="#your-first-python-based-workflow" id="toc-your-first-python-based-workflow" class="nav-link" data-scroll-target="#your-first-python-based-workflow">Your first Python-based workflow</a></li>
  <li><a href="#advanced-multi-job-workflow" id="toc-advanced-multi-job-workflow" class="nav-link" data-scroll-target="#advanced-multi-job-workflow">Advanced multi-job workflow</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/fastai/ghapi/tree/master/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Getting started with GitHub Actions</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="about-github-actions" class="level2">
<h2 class="anchored" data-anchor-id="about-github-actions">About GitHub Actions</h2>
<p><a href="https://docs.github.com/actions">GitHub Actions</a> help you automate tasks within your software development life cycle. GitHub say that:</p>
<blockquote class="blockquote">
<p>“<em>GitHub Actions are event-driven, meaning that you can run a series of commands after a specified event has occurred. For example, every time someone creates a pull request for a repository, you can automatically run a command that executes a software testing script.</em>”</p>
</blockquote>
<p>They are a powerful system for automating many software development processes, and open source projects get unlimited compute hours for free! A sequence of steps in GitHub Actions are be combined together into a “workflow”, which can furthermore contain multiple “jobs”, which are run on multiple machines, with (if needed) multiple operating systems, in parallel. For more information, read GitHub’s <a href="https://docs.github.com/actions/learn-github-actions/introduction-to-github-actions">Introduction to GitHub Actions</a>.</p>
<p>However, workflows can be difficult to create and debug, because:</p>
<ul>
<li>They run in a special environment which is difficult to replicate locally</li>
<li>Each time you make a change it takes quite a few minutes before your updated workflow is run and you can see the results</li>
<li>It is difficult to develop interatively and iteratively</li>
<li>The actions environment and contexts are complex and the documentation, whilst detailed, provides few real examples to work from</li>
<li>The main “language” for building workflows is a YAML-based language which is quite verbose, and doesn’t allow you to leverage your knowledge of other programming languages</li>
<li>Building full-featured extensions requires using TypeScript, which is not a language that most developers are used to using for scripting, sysadmin, and continuous integration tasks.</li>
</ul>
<p>However, with <a href="https://ghapi.fast.ai/cli.html#ghapi"><code>ghapi</code></a> you can write your workflows in Python and shell, and can do nearly all your development on your local machine. We’ll start by importing from the library, along with <code>fastcore</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ghapi.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="your-first-python-based-workflow" class="level2">
<h2 class="anchored" data-anchor-id="your-first-python-based-workflow">Your first Python-based workflow</h2>
<p>We’re going to help you get started by building a simple workflow which will add a comment to all new pull requests, saying “thank you” to the contributor.</p>
<p><a href="https://ghapi.fast.ai/core.html#ghapi"><code>GhApi</code></a> makes developing workflows easier, because your actual YAML file is created for you entirely automatically. To create the new workflow, run the <a href="https://ghapi.fast.ai/actions.html#create_workflow"><code>create_workflow</code></a> function, like so:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>create_workflow(name<span class="op">=</span><span class="st">'thankyou'</span>, event<span class="op">=</span>Event.pull_request)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now it’s time to create our python script. You’ll find it in <code>.github/scripts</code>, named based on your <a href="https://ghapi.fast.ai/actions.html#create_workflow"><code>create_workflow</code></a> parameters. The initial skeleton just contains import statements.</p>
<p>It will be much easier for us to iterate on our script if we have a sample <em>context</em> that the GitHub workflow runner will provide to us. We can get one by calling <a href="https://ghapi.fast.ai/actions.html#example_payload"><code>example_payload</code></a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>example <span class="op">=</span> example_payload(Event.pull_request)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(example)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['action', 'number', 'pull_request', 'repository', 'sender']</code></pre>
</div>
</div>
<p>For information about all the fields in a <em>payload</em>, use the GitHub <a href="https://docs.github.com/developers/webhooks-and-events/webhook-events-and-payloads#pull_request">webhook payload</a> documentation. For instance, the docs tell us that the “action” field can be:</p>
<blockquote class="blockquote">
<p>“<em>opened, edited, closed, assigned, unassigned, review_requested, review_request_removed, ready_for_review, labeled, unlabeled, synchronize, locked, unlocked, or reopened</em>”</p>
</blockquote>
<p>Let’s see what it contains for our example payload:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>example.action</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'opened'</code></pre>
</div>
</div>
<p>For our script, we should ensure that it’s only run for the <code>opened</code> action. Next up, we need to find out how to add a comment to a pull request. First, we’ll need to create our <a href="https://ghapi.fast.ai/core.html#ghapi"><code>GhApi</code></a> object. On your own PC, your GitHub token should be in the <code>GITHUB_TOKEN</code> environment variable, whereas when run in a workflow it will be part of the <code>github</code> context. The <a href="https://ghapi.fast.ai/actions.html#github_token"><code>github_token</code></a> function handles this for you automatically, so we can say:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>api <span class="op">=</span> GhApi(owner<span class="op">=</span><span class="st">'fastai'</span>, repo<span class="op">=</span><span class="st">'ghapi-test'</span>, token<span class="op">=</span>github_token())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One way to find the correct operation to call is to search the <a href="https://ghapi.fast.ai/fullapi.html">full API reference</a>. Operations are generally named as <code>{verb}_{object}</code>, so search for <code>create_comment</code>. Alternatively, you can jump to the section that you expect to contain your required operation – in this case, it’s important to know that GitHub considers a “pull request” to be a special kind of “issue”. After some looking through the page, we found this operation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>api.issues.create_comment</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><a href="https://docs.github.com/rest/reference/issues#create-an-issue-comment">issues.create_comment</a>(issue_number, body): <em>Create an issue comment</em></p>
</div>
</div>
<p>The hyperlink provided will take you to the GitHub docs for this operation, so take a look at that now. We need to provide an <code>issue_number</code> and the <code>body</code> of the comment. We can look inside the payload to find the issue number we need to use:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">', '</span>.join(example.pull_request)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'url, id, node_id, html_url, diff_url, patch_url, issue_url, number, state, locked, title, user, body, created_at, updated_at, closed_at, merged_at, merge_commit_sha, assignee, assignees, requested_reviewers, requested_teams, labels, milestone, commits_url, review_comments_url, review_comment_url, comments_url, statuses_url, head, base, _links, author_association, draft, merged, mergeable, rebaseable, mergeable_state, merged_by, comments, review_comments, maintainer_can_modify, commits, additions, deletions, changed_files'</code></pre>
</div>
</div>
<p>Since the docs call the parameter <code>issue_number</code>, and there is a <code>number</code> field here, that’s probably what we should use.</p>
<p>To test this out, we’ll first create a PR or issue, and then create our comment:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>com <span class="op">=</span> api.issues.create_comment(issue_number<span class="op">=</span><span class="dv">1</span>, body<span class="op">=</span><span class="st">'Thank you for your *valuable* contribution'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can view the comment by visiting its URL:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>com.url</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'https://api.github.com/repos/fastai/ghapi-test/issues/comments/1194507697'</code></pre>
</div>
</div>
<p>…and then delete it since we were just testing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>com <span class="op">=</span> api.issues.delete_comment(com.<span class="bu">id</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The payload will be available in the <a href="https://docs.github.com/actions/reference/context-and-expression-syntax-for-github-actions#github-context"><code>github</code> context</a>, which is provided automatically to you using the <code>context_github</code> variable. When running locally, an example github context will be used instead. (This example github context will not, in general, have the same payload as the event you’re using, so use the <code>example payload</code> for that.)</p>
<p>The <code>event</code> contains the actual payload:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(context_github.event)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['inputs', 'organization', 'ref', 'repository', 'sender', 'workflow']</code></pre>
</div>
</div>
<p>When we called <a href="https://ghapi.fast.ai/actions.html#create_workflow"><code>create_workflow</code></a>, the workflow it created can also be triggered using <a href="https://github.blog/changelog/2020-07-06-github-actions-manual-triggers-with-workflow_dispatch/">workflow dispatch</a>, which is more convenient for testing. In this case, our payload will not have the same information, so we should write our function in a way that can handle workflow dispatch as well.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>dispatch <span class="op">=</span> example_payload(Event.workflow_dispatch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can check what type of trigger we’re responding to, by checking the keys of our payload:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">'workflow'</span> <span class="kw">in</span> dispatch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>True</code></pre>
</div>
</div>
<p>In that case, we’ll use a fixed issue number, instead of using the actual payload number.</p>
<p>We can now write our function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> reply_thanks():</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    api <span class="op">=</span> GhApi(owner<span class="op">=</span><span class="st">'fastai'</span>, repo<span class="op">=</span><span class="st">'ghapi'</span>, token<span class="op">=</span>github_token())</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    payload <span class="op">=</span> context_github.event</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'workflow'</span> <span class="kw">in</span> payload: issue <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> payload.action <span class="op">!=</span> <span class="st">'opened'</span>: <span class="cf">return</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        issue <span class="op">=</span> payload.number</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    api.issues.create_comment(issue_number<span class="op">=</span>issue, body<span class="op">=</span><span class="st">'Thank you for your *valuable* contribution'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, copy this to the script in <code>.github/scripts</code>, along with a line to run it (<code>reply_thanks()</code>), and commit it to GitHub.</p>
<p>You can now test the workflow by going to GitHub, clicking the “Actions” tab, then clicking the workflow you just created, and then clicking the “Run workflow” button.</p>
<p>Alternatively, you can run it using <a href="https://ghapi.fast.ai/core.html#ghapi"><code>GhApi</code></a>, which we’ll do now:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>wf <span class="op">=</span> api.actions.get_workflow(<span class="st">'thankyou-pull_request.yml'</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>api.actions.create_workflow_dispatch(wf.<span class="bu">id</span>, ref<span class="op">=</span><span class="st">'master'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="sourceCode" id="cb22"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>To find out if the dispatch succeeded, go to the Actions tab on your repo and look for a yellow circle, which means it’s running, or a green tick, which means it succeeded. If you get a red cross, it failed - you can click the item for details. You can also get the results of the latest run through the API (but be sure to wait at least 30 seconds for the workflow to kick off):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>last_run <span class="op">=</span> api.actions.list_workflow_runs(wf.<span class="bu">id</span>).workflow_runs[<span class="dv">0</span>]</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>last_run.conclusion</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'failure'</code></pre>
</div>
</div>
<p>If it doesn’t work, you can add <code>print(payload)</code> after the first line, and when GitHub runs your workflow you’ll see the whole payload in your “Actions” panel.</p>
<p>Once it’s working OK using the manual workflow dispatch, try creating a pull request.</p>
</section>
<section id="advanced-multi-job-workflow" class="level2">
<h2 class="anchored" data-anchor-id="advanced-multi-job-workflow">Advanced multi-job workflow</h2>
<p>Sometimes, you need to join more than one <em>job</em> in a workflow. This isn’t common, but one example it’s absolutely needed is if you want to build software or run tests on multiple platforms, and then have some step that runs before or after all of them. For instance, building and releasing software that needs to be built on each platform requires one job to create a release, and then a separate job to do the builds and add artifacts to the release, since GitHub Actions runs all your steps in a job in a single platform. Furthermore, we need to set up <a href="https://docs.github.com/actions/learn-github-actions/managing-complex-workflows#creating-dependent-jobs">dependencies between jobs</a> using <code>needs</code>. <a href="https://ghapi.fast.ai/cli.html#ghapi"><code>ghapi</code></a> provides helpers to set up multi-job workflows with depedencies for you, which we’ll show an example of here.</p>
<p>In this tutorial we’re going to show how we created <a href="https://github.com/fastai/hugo-mathjax">hugo-mathjax</a>. The workflow in this project patches <a href="https://gohugo.io/">Hugo</a> to add <a href="https://www.mathjax.org/">Mathjax</a> support, then builds Mac, Ubuntu, and Windows versions of the software, creating a release which includes each of those builds as artifacts. It does the following:</p>
<ul>
<li>On a Ubuntu runner:
<ul>
<li>Find out what the latest release of Hugo is</li>
<li>It we haven’t yet built a patched version of this release, create a new release</li>
<li>Output the release number for the next job to use</li>
</ul></li>
<li>On Mac, Ubuntu, and Windows runners all running in parallel:
<ul>
<li>Get the release number output by the previous step</li>
<li>Download this release from the Hugo repo, and untar it</li>
<li>Patch, build, and tar this release</li>
<li>Add the tarred release as an artifact of the release created in the first job</li>
</ul></li>
</ul>
<p>First, we’ll create the workflow and script files:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>create_workflow(<span class="st">'create'</span>, Event.schedule, contexts<span class="op">=</span><span class="st">'needs'</span>, opersys<span class="op">=</span><span class="st">'macos, ubuntu, windows'</span>, prebuild<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This has some pieces we haven’t seen before, so let’s take a look at them now.</p>
<p>The <code>prebuild</code> bool tells <a href="https://ghapi.fast.ai/cli.html#ghapi"><code>ghapi</code></a> to include a prebuild job (see <a href="https://ghapi.fast.ai/actions.html#create_workflow"><code>create_workflow</code></a> for the full workflow created). After you run the above, take a look at the YAML that was created, to see how it all works. We’re going to need to modify the YAML, to add the <a href="https://docs.github.com/actions/reference/events-that-trigger-workflows#schedule">schedule</a> we want to run it on, using a <code>cron:</code> line. You can see the final YAML file <a href="https://github.com/fastai/hugo-mathjax/blob/master/.github/workflows/python.yml">here</a>.</p>
<p>The prebuild job calls a prebuild script using a Ubuntu runner. We’ll create the prebuild script now.</p>
<p>The script needs to get the current Hugo release tag:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>tag <span class="op">=</span> GhApi().repos.get_latest_release(<span class="st">'gohugoio'</span>, repo<span class="op">=</span><span class="st">'hugo'</span>).name</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>tag</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'v0.101.0'</code></pre>
</div>
</div>
<p>…and check whether we have released that patched version:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>api <span class="op">=</span> GhApi(owner<span class="op">=</span><span class="st">'fastai'</span>, repo<span class="op">=</span><span class="st">'hugo-mathjax'</span>, token<span class="op">=</span>github_token())</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>exists <span class="op">=</span> <span class="va">True</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: api.repos.get_release_by_tag(tag)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> HTTP404NotFoundError: exists <span class="op">=</span> <span class="va">False</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>exists</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>False</code></pre>
</div>
</div>
<p>In the case that the release already exists, we’ll want to just exit, otherwise we’ll create a new release:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>rel <span class="op">=</span> api.repos.create_release(tag, name<span class="op">=</span>tag)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>build</code> job will run in a separate runner, so we need to create an output telling it the tag of the release we’ve created. The <a href="https://ghapi.fast.ai/actions.html#actions_output"><code>actions_output</code></a> function does that, but print a special format that GitHub Actions uses:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>actions_output(<span class="st">'tag'</span>, tag)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>::set-output name=tag::v0.101.0</code></pre>
</div>
</div>
<p>You can see the completed prebuild script <a href="https://github.com/fastai/hugo-mathjax/blob/master/.github/scripts/prebuild.py">here</a>.</p>
<p>Now we can move on to creating the <code>build</code> script. First, we can get the outputs of the <code>prebuild</code> job as a <code>dict</code> by using <code>context_needs</code>, which contains information from any jobs in the <code>needs</code> section (which <a href="https://ghapi.fast.ai/cli.html#ghapi"><code>ghapi</code></a> will automatically set up for you if you enable <code>prebuild</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> loads(nested_idx(context_needs, <span class="st">'prebuild'</span>, <span class="st">'outputs'</span>, <span class="st">'out'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To get the <code>tag</code> output of the job, we index into the <code>dict</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>tag <span class="op">=</span> nested_idx(out, <span class="st">'step1'</span>, <span class="st">'outputs'</span>, <span class="st">'tag'</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>tag</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'v0.79.0'</code></pre>
</div>
</div>
<p>We get the release details using the same approach as before, then download, untar, patch, and build it. We won’t discuss those steps here since they’re not specific to <a href="https://ghapi.fast.ai/cli.html#ghapi"><code>ghapi</code></a>.</p>
<p>Once the software is built, we need to know the name of the created file, which depends on the operating system we’re running on. We can use the following approach to check:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>platform <span class="op">=</span> <span class="bu">dict</span>(linux<span class="op">=</span><span class="st">'linux'</span>, linux2<span class="op">=</span><span class="st">'linux'</span>, win32<span class="op">=</span><span class="st">'win'</span>, darwin<span class="op">=</span><span class="st">'mac'</span>)[sys.platform]</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>ext_nm <span class="op">=</span> <span class="st">'hugo.exe'</span> <span class="cf">if</span> platform<span class="op">==</span><span class="st">'win'</span> <span class="cf">else</span> <span class="st">'hugo'</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>ext_nm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'hugo'</code></pre>
</div>
</div>
<p>Finally, we can upload our file as an artifact:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>api <span class="op">=</span> GhApi(owner<span class="op">=</span><span class="st">'fastai'</span>, repo<span class="op">=</span><span class="st">'hugo-mathjax'</span>, token<span class="op">=</span>github_token())</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>rel <span class="op">=</span> api.repos.get_release_by_tag(tag)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>api.upload_file(rel, fn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can see the complete script <a href="https://github.com/fastai/hugo-mathjax/blob/master/.github/scripts/build.py">here</a>.</p>
<p>We’ve now successfully built a workflow that automatically patches, builds, and releases a mixed C/Go project, across multiple platforms, in parallel!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>